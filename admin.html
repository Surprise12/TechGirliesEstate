<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Estate Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body { 
    font-family: 'Roboto', Arial, sans-serif; 
    background: #f8f9fa; 
    color: #333;
    line-height: 1.6;
  }

  h1 { 
    background: #0077be; 
    color: #fff; 
    margin: 0; 
    padding: 20px; 
    text-align: center; 
    font-size: 24px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative;
  }

  #logoutBtn {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
  }

  #logoutBtn:hover {
    background: rgba(255,255,255,0.3);
  }

  #roleStatus { 
    padding: 15px; 
    text-align: center; 
    background: #fff;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 16px;
  }

  #content { 
    padding: 20px; 
    max-width: 1400px; 
    margin: auto; 
  }

  button { 
    padding: 12px 18px; 
    margin: 5px; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 14px;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  button:hover { 
    background: #005a8c; 
    color: #fff; 
    transform: translateY(-2px);
  }

  .btn-primary { background: #0077be; color: #fff; }
  .btn-success { background: #28a745; color: #fff; }
  .btn-danger { background: #dc3545; color: #fff; }
  .btn-warning { background: #ffc107; color: #000; }
  .btn-info { background: #17a2b8; color: #fff; }

  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 10px; 
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  th, td { 
    border: 1px solid #ddd; 
    padding: 12px; 
    text-align: left; 
  }

  th { 
    background: #0077be; 
    color: #fff; 
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  tr:nth-child(even) { background: #f8f9fa; }
  tr:hover { background: #e9ecef; }

  .pagination { 
    display: flex; 
    justify-content: center; 
    margin-top: 20px; 
    gap: 5px;
    flex-wrap: wrap;
  }

  .pagination button { 
    margin: 0 2px; 
    padding: 10px 15px;
  }

  .pagination button.active {
    background: #0077be;
    color: white;
  }

  #imageDropArea { 
    border: 2px dashed #ccc; 
    padding: 30px; 
    text-align: center; 
    margin-top: 10px; 
    border-radius: 8px;
    background: #fafafa;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  #imageDropArea.dragover {
    border-color: #0077be;
    background: #f0f8ff;
  }

  #imagePreview { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    margin-top: 10px; 
  }

  #imagePreview img { 
    width: 100px; 
    height: 100px; 
    object-fit: cover; 
    border-radius: 4px; 
    border: 2px solid #ddd;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
    font-size: 14px;
  }

  .form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
    font-family: inherit;
    transition: border-color 0.3s;
  }

  .form-control:focus {
    border-color: #0077be;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,119,190,0.1);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  /* Fallback for older browsers */
  @supports not (display: grid) {
    .form-grid {
      display: flex;
      flex-wrap: wrap;
    }
    
    .form-grid .form-group {
      flex: 1 1 45%;
      margin: 10px;
    }
    
    .form-full {
      flex: 1 1 100%;
    }
  }

  .form-full {
    grid-column: 1 / -1;
  }

  .card {
    background: #fff;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .card h3 {
    margin-top: 0;
    color: #0077be;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 15px;
    margin-bottom: 20px;
    font-size: 20px;
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    display: inline-block;
  }

  .status-available { background: #d4edda; color: #155724; }
  .status-sold { background: #f8d7da; color: #721c24; }
  .status-rented { background: #fff3cd; color: #856404; }
  .status-under-offer { background: #cce7ff; color: #004085; }

  .login-panel {
    max-width: 400px;
    margin: 50px auto;
    padding: 30px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  /* Fallback for older browsers */
  @supports not (display: grid) {
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    
    .stats-grid .stat-card {
      flex: 1 1 200px;
      margin: 10px;
    }
  }

  .stat-card {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s;
  }

  .stat-card:hover {
    transform: translateY(-5px);
  }

  .stat-card h4 {
    margin: 0 0 15px 0;
    color: #666;
    font-size: 14px;
    font-weight: 600;
  }

  .stat-card .number {
    font-size: 28px;
    font-weight: bold;
    color: #0077be;
  }

  .bulk-actions {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .action-buttons button {
    padding: 8px 12px;
    font-size: 12px;
  }

  .image-preview-container {
    position: relative;
    display: inline-block;
    margin: 5px;
  }

  .image-preview-container img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 6px;
  }

  .remove-image {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Property Form Modal */
  #propertyFormModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
  }

  #propertyFormModal.show {
    display: flex !important;
  }

  #propertyFormContent {
    background: #fff;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 15px;
    padding: 30px;
    position: relative;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }

  #closePropertyForm {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    cursor: pointer;
    color: #666;
    background: none;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    z-index: 2001;
  }

  #closePropertyForm:hover {
    background-color: #f0f0f0;
    color: #333;
  }

  /* Browser compatibility fixes */
  .flex { display: flex; }
  .hidden { display: none !important; }
  .block { display: block; }
  .show { display: block !important; }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .bulk-actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    table {
      font-size: 12px;
    }
    
    th, td {
      padding: 8px;
    }
    
    #content {
      padding: 15px;
    }
    
    .card {
      padding: 20px;
    }
    
    #propertyFormContent {
      padding: 20px;
      margin: 10px;
    }
  }

  @media (max-width: 480px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .pagination button {
      padding: 8px 12px;
      margin: 2px;
    }
    
    .action-buttons {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<h1>Estate Management Dashboard
  <button id="logoutBtn" class="hidden"><i class="fas fa-sign-out-alt"></i> Logout</button>
</h1>

<!-- Login Panel -->
<div id="loginPanel" class="login-panel">
  <h3>Admin Login</h3>
  <form id="loginForm">
    <div class="form-group">
      <label for="username">Username:</label>
      <input type="text" id="username" class="form-control" placeholder="Enter username" required />
    </div>
    <div class="form-group">
      <label for="password">Password:</label>
      <input type="password" id="password" class="form-control" placeholder="Enter password" required />
    </div>
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button type="submit" class="btn-primary" style="flex: 1;">Login</button>
      <button type="button" class="btn-primary" style="flex: 1;" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left"></i> Go Back To Estate Dashboard
      </button>
    </div>
  </form>
  <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; font-size: 13px; border-left: 4px solid #ffc107;">
    <strong>Demo Credentials:</strong><br>
    Username: admin<br>
    Password: admin123
  </div>
</div>

<div id="content" class="hidden">

<!-- Admin Panel -->
<div id="adminPanel" class="hidden">
  <!-- Statistics -->
  <div class="stats-grid">
    <div class="stat-card">
      <h4>Total Properties</h4>
      <div class="number" id="statTotal">0</div>
    </div>
    <div class="stat-card">
      <h4>Available</h4>
      <div class="number" id="statAvailable">0</div>
    </div>
    <div class="stat-card">
      <h4>Sold</h4>
      <div class="number" id="statSold">0</div>
    </div>
    <div class="stat-card">
      <h4>Total Value</h4>
      <div class="number" id="statValue">R 0</div>
    </div>
  </div>

  <!-- Add Property Button -->
  <div class="card" style="text-align: center;">
    <button id="addPropertyBtn" class="btn-success" style="font-size: 18px; padding: 15px 30px;">
      <i class="fas fa-plus-circle"></i> Add New Property
    </button>
  </div>

  <!-- Bulk Actions -->
  <div class="bulk-actions">
    <div style="flex: 1;">
      <strong>Bulk Actions:</strong>
    </div>
    <button id="bulkDelete" class="btn-danger">
      <i class="fas fa-trash"></i> Delete Selected
    </button>
    <select id="bulkStatus" class="form-control" style="width: 200px;">
      <option value="">Update Status</option>
      <option>Available</option>
      <option>Sold</option>
      <option>Rented</option>
    </select>
    <button id="bulkUpdateStatus" class="btn-primary">
      <i class="fas fa-sync"></i> Apply
    </button>
  </div>

  <!-- Properties Table -->
  <div class="card">
    <h3>Manage Properties</h3>
    
    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
      <input type="text" id="adminSearch" class="form-control" placeholder="Search properties..." 
             style="flex: 1; min-width: 250px;" />
      <button id="exportCSV" class="btn-success">
        <i class="fas fa-download"></i> Export CSV
      </button>
      <button id="exportAnalytics" class="btn-info">
        <i class="fas fa-chart-bar"></i> Export Analytics
      </button>
      <input type="file" id="importCSVFile" class="hidden" accept=".csv" />
      <button id="importCSV" class="btn-warning">
        <i class="fas fa-upload"></i> Import CSV
      </button>
    </div>

    <table>
      <thead>
        <tr>
          <th width="40">
            <input type="checkbox" id="selectAll" />
          </th>
          <th>Title</th>
          <th>Type</th>
          <th>Status</th>
          <th>Location</th>
          <th>Price</th>
          <th>Bed/Bath</th>
          <th>Size</th>
          <th>Images</th>
          <th>Date Added</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="adminTableBody"></tbody>
    </table>
    
    <div class="pagination" id="paginationControls"></div>
  </div>
</div>

</div>

<!-- Property Form Modal -->
<div id="propertyFormModal">
  <div id="propertyFormContent">
    <button id="closePropertyForm">×</button>
    <h3 id="formTitle">Add New Property</h3>
    <form id="propertyForm">
      <input type="hidden" id="propId" />
      
      <div class="form-grid">
        <div class="form-group">
          <label for="title">Property Title *</label>
          <input type="text" id="title" class="form-control" placeholder="Enter property title" required />
        </div>
        
        <div class="form-group">
          <label for="type">Property Type *</label>
          <select id="type" class="form-control" required>
            <option value="">Select Type</option>
            <option>House</option>
            <option>Apartment</option>
            <option>Commercial</option>
            <option>Land</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="status">Status *</label>
          <select id="status" class="form-control" required>
            <option value="">Select Status</option>
            <option>Available</option>
            <option>Sold</option>
            <option>Rented</option>
            <option>Under Offer</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="price">Price (R) *</label>
          <input type="number" id="price" class="form-control" placeholder="Enter price" required />
        </div>
        
        <div class="form-group">
          <label for="location">Location *</label>
          <input type="text" id="location" class="form-control" placeholder="Enter location" required />
        </div>
        
        <div class="form-group">
          <label for="bedrooms">Bedrooms</label>
          <input type="number" id="bedrooms" class="form-control" placeholder="Number of bedrooms" />
        </div>
        
        <div class="form-group">
          <label for="bathrooms">Bathrooms</label>
          <input type="number" id="bathrooms" class="form-control" placeholder="Number of bathrooms" />
        </div>
        
        <div class="form-group">
          <label for="squareMeters">Square Meters</label>
          <input type="number" id="squareMeters" class="form-control" placeholder="Property size in m²" />
        </div>
        
        <div class="form-group">
          <label for="parkingSpaces">Parking Spaces</label>
          <input type="number" id="parkingSpaces" class="form-control" placeholder="Number of parking spaces" />
        </div>
        
        <div class="form-group">
          <label for="furnishing">Furnishing</label>
          <select id="furnishing" class="form-control">
            <option value="">Select Option</option>
            <option>Furnished</option>
            <option>Unfurnished</option>
            <option>Partially Furnished</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="petFriendly">Pet Friendly</label>
          <select id="petFriendly" class="form-control">
            <option value="">Select Option</option>
            <option>Yes</option>
            <option>No</option>
          </select>
        </div>
        
        <div class="form-group form-full">
          <label for="description">Property Description</label>
          <textarea id="description" class="form-control" placeholder="Describe the property" rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label for="owner">Owner Name *</label>
          <input type="text" id="owner" class="form-control" placeholder="Owner's full name" required />
        </div>
        
        <div class="form-group">
          <label for="ownerPhone">Owner Phone *</label>
          <input type="tel" id="ownerPhone" class="form-control" placeholder="Owner's phone number" required />
        </div>
        
        <div class="form-group">
          <label for="ownerEmail">Owner Email *</label>
          <input type="email" id="ownerEmail" class="form-control" placeholder="Owner's email address" required />
        </div>
        
        <div class="form-group form-full">
          <label for="ownerAddress">Owner Address *</label>
          <textarea id="ownerAddress" class="form-control" placeholder="Owner's physical address" required></textarea>
        </div>
        
        <div class="form-group form-full">
          <label for="features">Features (comma separated)</label>
          <input type="text" id="features" class="form-control" placeholder="Swimming Pool, Garden, Garage, etc." />
        </div>
        
        <!-- Enhanced Image Upload with 10 images -->
        <div class="form-group form-full">
          <label>Property Images (Max 10 Images)</label>
          <div id="imageDropArea">
            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
            <p style="margin-bottom: 15px; color: #666;">Drag & drop up to 10 images here or click to browse</p>
            <button type="button" id="browseImages" class="btn-primary">
              <i class="fas fa-folder-open"></i> Browse Files
            </button>
            <input type="file" id="imageUpload" multiple accept="image/*" class="hidden" />
          </div>
          <div id="imagePreview"></div>
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <i class="fas fa-info-circle"></i> You can upload up to 10 images. First image will be the main display image.
          </div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button type="button" id="saveProperty" class="btn-success">
          <i class="fas fa-save"></i> Save Property
        </button>
        <button type="button" id="resetForm" class="btn-warning">
          <i class="fas fa-redo"></i> Reset Form
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // =================== COMPATIBILITY FIXES ===================
  
  // Enhanced localStorage with fallback
  var storage = {
    setItem: function(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (e) {
        // Fallback to sessionStorage or in-memory storage
        try {
          sessionStorage.setItem(key, value);
        } catch (e2) {
          // Final fallback to in-memory storage
          this.memoryStorage = this.memoryStorage || {};
          this.memoryStorage[key] = value;
        }
      }
    },
    
    getItem: function(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        try {
          return sessionStorage.getItem(key);
        } catch (e2) {
          return (this.memoryStorage && this.memoryStorage[key]) || null;
        }
      }
    }
  };

  // Check if browser supports modern features
  function checkBrowserCompatibility() {
    var issues = [];
    
    // Check for localStorage
    try {
      storage.setItem('test', 'test');
      storage.removeItem('test');
    } catch (e) {
      issues.push('localStorage not available - using fallback storage');
    }
    
    // Check for ES6 features
    if (typeof Symbol === 'undefined') {
      issues.push('ES6 not fully supported - some features may not work');
    }
    
    // Check for CSS Grid
    var gridSupport = CSS && CSS.supports && CSS.supports('display', 'grid');
    if (!gridSupport) {
      issues.push('CSS Grid not supported - using flexbox fallback');
    }
    
    if (issues.length > 0) {
      console.warn('Compatibility issues detected:', issues);
    }
    
    return issues;
  }

  // =================== Configuration ===================
  var ADMIN_CREDENTIALS = {
    username: 'admin',
    password: 'admin123'
  };

  // =================== Global Variables ===================
  var currentRole = 'guest';
  var properties = [];
  var displayProperties = [];
  var tempImages = [];
  var pageSize = 10;
  var currentPage = 1;
  var inactivityTimer;

  // =================== Initialize Application ===================
  function init() {
    console.log('Initializing Admin Dashboard...');
    
    // Check browser compatibility
    checkBrowserCompatibility();
    
    // Load properties and sync with index.html
    loadAndSyncProperties();
    setupEventListeners();
    checkAdminSession();
    
    console.log('Admin Dashboard initialized');
  }

  // =================== Property Synchronization ===================
  function loadAndSyncProperties() {
    // Try to get properties from storage first
    var storedProperties = storage.getItem('properties');
    
    if (storedProperties) {
      try {
        properties = JSON.parse(storedProperties);
      } catch (e) {
        console.warn('Failed to parse stored properties, using sample data');
        properties = getSampleProperties();
        storage.setItem('properties', JSON.stringify(properties));
      }
    } else {
      // If no properties in storage, create sample data
      properties = getSampleProperties();
      storage.setItem('properties', JSON.stringify(properties));
    }
    
    // Set up storage event listener for cross-tab synchronization
    window.addEventListener('storage', function(e) {
      if (e.key === 'properties') {
        try {
          properties = JSON.parse(e.newValue || '[]');
          if (currentRole === 'admin') {
            loadAdminProperties();
          }
        } catch (error) {
          console.error('Error syncing properties:', error);
        }
      }
    });
  }

  function syncPropertiesToIndex() {
    // Update storage
    storage.setItem('properties', JSON.stringify(properties));
    
    // Also try to update any open index.html tabs
    try {
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'properties',
        newValue: JSON.stringify(properties)
      }));
    } catch (e) {
      console.log('Storage event dispatch not supported');
    }
  }

  function getSampleProperties() {
    return [
      {
        id: Date.now().toString(),
        title: 'Luxury Villa in Pretoria',
        price: 8500000,
        images: [
          'https://images.unsplash.com/photo-1613977257363-707ba9348227?w=800',
          'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800',
          'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800'
        ],
        owner: 'John Davidson',
        ownerPhone: '+27123456789',
        ownerEmail: 'john@example.com',
        ownerAddress: '123 Luxury Street, Waterkloof, Pretoria',
        location: 'Pretoria',
        type: 'House',
        bedrooms: 5,
        bathrooms: 4,
        squareMeters: 650,
        parkingSpaces: 4,
        furnishing: 'Furnished',
        petFriendly: 'Yes',
        description: 'Stunning luxury villa with panoramic views, modern amenities, and premium finishes throughout.',
        status: 'Available',
        dateAdded: new Date().toISOString().split('T')[0],
        features: ['Swimming Pool', 'Garden', 'Security System', 'Double Garage', 'Fireplace']
      }
    ];
  }

  // =================== Event Listeners ===================
  function setupEventListeners() {
    console.log('Setting up admin event listeners...');
    
    // Login buttons
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Property form buttons
    document.getElementById('addPropertyBtn').addEventListener('click', showPropertyForm);
    document.getElementById('saveProperty').addEventListener('click', saveProperty);
    document.getElementById('resetForm').addEventListener('click', resetForm);
    document.getElementById('closePropertyForm').addEventListener('click', hidePropertyForm);

    // Bulk action buttons
    document.getElementById('bulkDelete').addEventListener('click', bulkDelete);
    document.getElementById('bulkUpdateStatus').addEventListener('click', bulkUpdateStatus);
    document.getElementById('selectAll').addEventListener('change', toggleSelectAll);

    // Export/Import buttons
    document.getElementById('exportCSV').addEventListener('click', exportCSV);
    document.getElementById('exportAnalytics').addEventListener('click', exportAnalytics);
    document.getElementById('importCSV').addEventListener('click', function() { 
      document.getElementById('importCSVFile').click(); 
    });
    document.getElementById('importCSVFile').addEventListener('change', handleCSVImport);
    document.getElementById('adminSearch').addEventListener('input', filterProperties);

    // Image upload functionality
    var imageDropArea = document.getElementById('imageDropArea');
    imageDropArea.addEventListener('click', function() { 
      document.getElementById('imageUpload').click(); 
    });
    imageDropArea.addEventListener('dragover', handleDragOver);
    imageDropArea.addEventListener('dragleave', handleDragLeave);
    imageDropArea.addEventListener('drop', handleDrop);
    
    document.getElementById('browseImages').addEventListener('click', function() { 
      document.getElementById('imageUpload').click(); 
    });
    document.getElementById('imageUpload').addEventListener('change', handleFileSelect);

    // Close modal when clicking outside
    document.getElementById('propertyFormModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hidePropertyForm();
      }
    });

    // Reset inactivity timer on user activity
    var events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
    for (var i = 0; i < events.length; i++) {
      document.addEventListener(events[i], resetInactivityTimer);
    }

    console.log('Admin event listeners setup complete');
  }

  // =================== Authentication System ===================
  function handleLogin(e) {
    e.preventDefault();
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;
    
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
      loginAsAdmin();
    } else {
      alert('Invalid admin credentials! Please try again.');
    }
  }

  function loginAsAdmin() {
    currentRole = 'admin';
    
    // Hide login panel
    document.getElementById('loginPanel').classList.add('hidden');
    
    // Show content and admin panel
    document.getElementById('content').classList.remove('hidden');
    document.getElementById('adminPanel').classList.remove('hidden');
    document.getElementById('logoutBtn').classList.remove('hidden');
    
    // Load admin data
    loadAdminProperties();
    updateStatistics();
    
    // Set session
    try {
      sessionStorage.setItem('adminLoggedIn', 'true');
      sessionStorage.setItem('adminSession', Date.now().toString());
    } catch (e) {
      console.warn('Session storage not available');
    }
    resetInactivityTimer();
    
    console.log('Admin logged in successfully');
  }

  function logout() {
    currentRole = 'guest';
    
    // Hide admin content
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('content').classList.add('hidden');
    document.getElementById('logoutBtn').classList.add('hidden');
    
    // Show login panel
    document.getElementById('loginPanel').classList.remove('hidden');
    
    // Clear session
    try {
      sessionStorage.removeItem('adminLoggedIn');
      sessionStorage.removeItem('adminSession');
    } catch (e) {
      console.warn('Session storage not available');
    }
    clearTimeout(inactivityTimer);
    
    // Reset login form
    document.getElementById('loginForm').reset();
    
    console.log('Admin logged out');
  }

  function checkAdminSession() {
    try {
      var loggedIn = sessionStorage.getItem('adminLoggedIn');
      var sessionTime = sessionStorage.getItem('adminSession');
      
      if (loggedIn === 'true' && sessionTime) {
        var sessionAge = Date.now() - parseInt(sessionTime);
        if (sessionAge < 2 * 60 * 60 * 1000) { // 2 hours
          loginAsAdmin();
        } else {
          logout();
        }
      }
    } catch (e) {
      console.warn('Session storage not available');
    }
  }

  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    if (currentRole === 'admin') {
      inactivityTimer = setTimeout(function() {
        alert('Session expired due to inactivity');
        logout();
      }, 30 * 60 * 1000); // 30 minutes
    }
  }

  // =================== Property Form Modal ===================
  function showPropertyForm() {
    resetForm();
    document.getElementById('propertyFormModal').classList.add('show');
    document.getElementById('formTitle').textContent = 'Add New Property';
  }

  function hidePropertyForm() {
    document.getElementById('propertyFormModal').classList.remove('show');
  }

  // =================== Image Upload Handling ===================
  function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('imageDropArea').classList.add('dragover');
  }

  function handleDragLeave(e) {
    e.preventDefault();
    document.getElementById('imageDropArea').classList.remove('dragover');
  }

  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('imageDropArea').classList.remove('dragover');
    var files = e.dataTransfer.files;
    handleFiles(files);
  }

  function handleFileSelect(e) {
    var files = e.target.files;
    handleFiles(files);
  }

  function handleFiles(files) {
    if (tempImages.length + files.length > 10) {
      alert('Maximum 10 images allowed per property');
      return;
    }

    var fileArray = Array.prototype.slice.call(files);
    for (var i = 0; i < Math.min(fileArray.length, 10 - tempImages.length); i++) {
      var file = fileArray[i];
      if (!file.type.match('image.*')) {
        alert('Please upload only image files');
        continue;
      }

      var reader = new FileReader();
      reader.onload = (function(file) {
        return function(e) {
          var container = document.createElement('div');
          container.className = 'image-preview-container';
          
          var img = document.createElement('img');
          img.src = e.target.result;
          
          var removeBtn = document.createElement('button');
          removeBtn.className = 'remove-image';
          removeBtn.innerHTML = '×';
          removeBtn.addEventListener('click', function() {
            var index = tempImages.indexOf(e.target.result);
            if (index > -1) {
              tempImages.splice(index, 1);
            }
            container.remove();
          });

          container.appendChild(img);
          container.appendChild(removeBtn);
          
          document.getElementById('imagePreview').appendChild(container);
          tempImages.push(e.target.result);
        };
      })(file);
      reader.readAsDataURL(file);
    }
  }

  // =================== Property Management ===================
  function loadAdminProperties() {
    displayProperties = properties.slice();
    currentPage = 1;
    renderAdminTable();
    updateStatistics();
  }

  function saveProperties() {
    storage.setItem('properties', JSON.stringify(properties));
    updateStatistics();
    syncPropertiesToIndex(); // Sync with index.html
  }

  function updateStatistics() {
    var total = properties.length;
    var available = properties.filter(function(p) { return p.status === 'Available'; }).length;
    var sold = properties.filter(function(p) { return p.status === 'Sold'; }).length;
    var totalValue = properties.reduce(function(sum, p) { return sum + (p.price || 0); }, 0);
    
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statAvailable').textContent = available;
    document.getElementById('statSold').textContent = sold;
    document.getElementById('statValue').textContent = 'R ' + totalValue.toLocaleString();
  }

  function resetForm() {
    document.getElementById('propertyForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
    tempImages = [];
    document.getElementById('propId').value = '';
  }

  function saveProperty() {
    var id = document.getElementById('propId').value;
    var title = document.getElementById('title').value;
    var type = document.getElementById('type').value;
    var status = document.getElementById('status').value;
    var price = parseFloat(document.getElementById('price').value);
    var location = document.getElementById('location').value;
    var bedrooms = parseInt(document.getElementById('bedrooms').value) || 0;
    var bathrooms = parseInt(document.getElementById('bathrooms').value) || 0;
    var squareMeters = parseInt(document.getElementById('squareMeters').value) || 0;
    var parkingSpaces = parseInt(document.getElementById('parkingSpaces').value) || 0;
    var furnishing = document.getElementById('furnishing').value;
    var petFriendly = document.getElementById('petFriendly').value;
    var description = document.getElementById('description').value;
    var owner = document.getElementById('owner').value;
    var ownerPhone = document.getElementById('ownerPhone').value;
    var ownerEmail = document.getElementById('ownerEmail').value;
    var ownerAddress = document.getElementById('ownerAddress').value;
    var features = document.getElementById('features').value.split(',').map(function(f) { 
      return f.trim(); 
    }).filter(function(f) { 
      return f; 
    });
    
    var images = tempImages.slice();

    // Validation
    if (!title || !type || !status || !price || !location || !owner || !ownerPhone || !ownerEmail || !ownerAddress) {
      alert('Please fill in all required fields (marked with *)');
      return;
    }

    var property = {
      id: id || Date.now().toString(),
      title: title,
      type: type,
      status: status,
      price: price,
      location: location,
      bedrooms: bedrooms,
      bathrooms: bathrooms,
      squareMeters: squareMeters,
      parkingSpaces: parkingSpaces,
      furnishing: furnishing,
      petFriendly: petFriendly,
      description: description,
      owner: owner,
      ownerPhone: ownerPhone,
      ownerEmail: ownerEmail,
      ownerAddress: ownerAddress,
      features: features,
      images: images,
      dateAdded: id ? (properties.find(function(p) { return p.id === id; }) || {}).dateAdded : new Date().toISOString().split('T')[0],
      lastModified: new Date().toISOString()
    };

    if (id) {
      // Update existing property
      var index = properties.findIndex(function(p) { return p.id === id; });
      if (index !== -1) {
        properties[index] = property;
      }
    } else {
      // Add new property
      properties.push(property);
    }
    
    saveProperties();
    loadAdminProperties();
    hidePropertyForm();
    alert('Property saved successfully!');
  }

  function editProperty(propertyId) {
    var property = properties.find(function(p) { return p.id === propertyId; });
    if (!property) return;

    // Fill form with property data
    document.getElementById('propId').value = property.id;
    document.getElementById('title').value = property.title;
    document.getElementById('type').value = property.type;
    document.getElementById('status').value = property.status;
    document.getElementById('price').value = property.price;
    document.getElementById('location').value = property.location;
    document.getElementById('bedrooms').value = property.bedrooms || '';
    document.getElementById('bathrooms').value = property.bathrooms || '';
    document.getElementById('squareMeters').value = property.squareMeters || '';
    document.getElementById('parkingSpaces').value = property.parkingSpaces || '';
    document.getElementById('furnishing').value = property.furnishing || '';
    document.getElementById('petFriendly').value = property.petFriendly || '';
    document.getElementById('description').value = property.description || '';
    document.getElementById('owner').value = property.owner;
    document.getElementById('ownerPhone').value = property.ownerPhone;
    document.getElementById('ownerEmail').value = property.ownerEmail;
    document.getElementById('ownerAddress').value = property.ownerAddress;
    document.getElementById('features').value = property.features ? property.features.join(', ') : '';

    // Show images
    var preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    property.images.forEach(function(src) {
      var container = document.createElement('div');
      container.className = 'image-preview-container';
      
      var img = document.createElement('img');
      img.src = src;
      
      var removeBtn = document.createElement('button');
      removeBtn.className = 'remove-image';
      removeBtn.innerHTML = '×';
      removeBtn.addEventListener('click', function() {
        var index = tempImages.indexOf(src);
        if (index > -1) {
          tempImages.splice(index, 1);
        }
        container.remove();
      });

      container.appendChild(img);
      container.appendChild(removeBtn);
      preview.appendChild(container);
    });
    tempImages = property.images.slice();

    document.getElementById('formTitle').textContent = 'Edit Property';
    document.getElementById('propertyFormModal').classList.add('show');
  }

  function deleteProperty(propertyId) {
    if (confirm('Are you sure you want to delete this property?')) {
      properties = properties.filter(function(p) { return p.id !== propertyId; });
      saveProperties();
      loadAdminProperties();
      alert('Property deleted successfully!');
    }
  }

  function duplicateProperty(propertyId) {
    var original = properties.find(function(p) { return p.id === propertyId; });
    if (!original) return;

    var duplicate = JSON.parse(JSON.stringify(original));
    duplicate.id = Date.now().toString();
    duplicate.title = original.title + ' (Copy)';
    duplicate.status = 'Available';
    duplicate.dateAdded = new Date().toISOString().split('T')[0];
    
    properties.push(duplicate);
    saveProperties();
    loadAdminProperties();
    alert('Property duplicated successfully!');
  }

  // =================== Table & Pagination ===================
  function filterProperties() {
    var searchVal = document.getElementById('adminSearch').value.toLowerCase();
    displayProperties = properties.filter(function(p) { 
      return p.title.toLowerCase().includes(searchVal) || 
             (p.owner && p.owner.toLowerCase().includes(searchVal)) ||
             p.location.toLowerCase().includes(searchVal) ||
             p.type.toLowerCase().includes(searchVal);
    });
    currentPage = 1;
    renderAdminTable();
  }

  function renderAdminTable() {
    var tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    
    var start = (currentPage - 1) * pageSize;
    var pageItems = displayProperties.slice(start, start + pageSize);
    
    if (pageItems.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-home" style="font-size: 48px; margin-bottom: 10px;"></i><p>No properties found</p></td></tr>';
      renderPagination();
      return;
    }

    pageItems.forEach(function(p) {
      var tr = document.createElement('tr');
      tr.innerHTML = '<td><input type="checkbox" class="property-checkbox" data-id="' + p.id + '" /></td>' +
        '<td><strong>' + p.title + '</strong></td>' +
        '<td>' + p.type + '</td>' +
        '<td><span class="status-badge status-' + p.status.toLowerCase().replace(' ', '-') + '">' + p.status + '</span></td>' +
        '<td>' + p.location + '</td>' +
        '<td><strong>R ' + (p.price || 0).toLocaleString() + '</strong></td>' +
        '<td>' + (p.bedrooms || 0) + ' / ' + (p.bathrooms || 0) + '</td>' +
        '<td>' + (p.squareMeters || 'N/A') + ' m²</td>' +
        '<td>' + (p.images ? p.images.length : 0) + ' images</td>' +
        '<td>' + (p.dateAdded || 'N/A') + '</td>' +
        '<td><div class="action-buttons">' +
        '<button onclick="editProperty(\'' + p.id + '\')" class="btn-primary" title="Edit"><i class="fas fa-edit"></i></button>' +
        '<button onclick="deleteProperty(\'' + p.id + '\')" class="btn-danger" title="Delete"><i class="fas fa-trash"></i></button>' +
        '<button onclick="duplicateProperty(\'' + p.id + '\')" class="btn-info" title="Duplicate"><i class="fas fa-copy"></i></button>' +
        '</div></td>';
      tbody.appendChild(tr);
    });
    
    renderPagination();
  }

  function renderPagination() {
    var totalPages = Math.ceil(displayProperties.length / pageSize);
    var container = document.getElementById('paginationControls');
    container.innerHTML = '';
    
    if (totalPages <= 1) return;

    for (var i = 1; i <= totalPages; i++) {
      var btn = document.createElement('button');
      btn.innerText = i;
      if (i === currentPage) {
        btn.classList.add('active');
        btn.disabled = true;
      }
      btn.onclick = (function(page) {
        return function() {
          currentPage = page;
          renderAdminTable();
        };
      })(i);
      container.appendChild(btn);
    }
  }

  // =================== Bulk Actions ===================
  function toggleSelectAll() {
    var checkboxes = document.querySelectorAll('.property-checkbox');
    var selectAll = document.getElementById('selectAll').checked;
    
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = selectAll;
    }
  }

  function getSelectedProperties() {
    var checkboxes = document.querySelectorAll('.property-checkbox:checked');
    var selectedIds = [];
    for (var i = 0; i < checkboxes.length; i++) {
      selectedIds.push(checkboxes[i].dataset.id);
    }
    return selectedIds;
  }

  function bulkDelete() {
    var selectedIds = getSelectedProperties();
    if (selectedIds.length === 0) {
      alert('Please select properties to delete');
      return;
    }
    
    if (confirm('Are you sure you want to delete ' + selectedIds.length + ' properties? This action cannot be undone.')) {
      properties = properties.filter(function(p) { 
        return !selectedIds.includes(p.id); 
      });
      saveProperties();
      loadAdminProperties();
      alert('Successfully deleted ' + selectedIds.length + ' properties.');
    }
  }

  function bulkUpdateStatus() {
    var selectedIds = getSelectedProperties();
    var newStatus = document.getElementById('bulkStatus').value;
    
    if (selectedIds.length === 0) {
      alert('Please select properties to update');
      return;
    }
    
    if (!newStatus) {
      alert('Please select a status to apply');
      return;
    }
    
    properties.forEach(function(p) {
      if (selectedIds.includes(p.id)) {
        p.status = newStatus;
        p.lastModified = new Date().toISOString();
      }
    });
    
    saveProperties();
    loadAdminProperties();
    alert('Updated status for ' + selectedIds.length + ' properties to "' + newStatus + '".');
    document.getElementById('bulkStatus').value = '';
  }

  // =================== Export/Import ===================
  function exportCSV() {
    var csv = 'ID,Title,Type,Status,Price,Location,Bedrooms,Bathrooms,SquareMeters,ParkingSpaces,Furnishing,PetFriendly,Description,Owner,OwnerPhone,OwnerEmail,OwnerAddress,Features,Images,DateAdded\n';
    
    properties.forEach(function(p) {
      var row = [
        p.id,
        '"' + p.title + '"',
        p.type,
        p.status,
        p.price,
        '"' + p.location + '"',
        p.bedrooms || 0,
        p.bathrooms || 0,
        p.squareMeters || 0,
        p.parkingSpaces || 0,
        p.furnishing || '',
        p.petFriendly || '',
        '"' + (p.description || '').replace(/"/g, '""') + '"',
        '"' + p.owner + '"',
        p.ownerPhone,
        '"' + p.ownerEmail + '"',
        '"' + (p.ownerAddress || '').replace(/"/g, '""') + '"',
        '"' + (p.features || []).join(',') + '"',
        '"' + (p.images || []).join('|') + '"',
        p.dateAdded || ''
      ];
      csv += row.join(',') + '\n';
    });
    
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'properties-export-' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportAnalytics() {
    var analytics = {
      exportDate: new Date().toISOString(),
      totalProperties: properties.length,
      statistics: {
        byType: {},
        byStatus: {},
        byLocation: {}
      },
      financials: {
        totalPortfolioValue: properties.reduce(function(sum, p) { return sum + (p.price || 0); }, 0),
        averagePrice: properties.length > 0 ? properties.reduce(function(sum, p) { return sum + (p.price || 0); }, 0) / properties.length : 0,
        highestPrice: Math.max.apply(Math, properties.map(function(p) { return p.price || 0; })),
        lowestPrice: Math.min.apply(Math, properties.map(function(p) { return p.price || 0; }))
      },
      properties: properties.map(function(p) {
        return {
          id: p.id,
          title: p.title,
          type: p.type,
          status: p.status,
          price: p.price,
          location: p.location,
          dateAdded: p.dateAdded
        };
      })
    };

    // Calculate statistics
    properties.forEach(function(p) {
      analytics.statistics.byType[p.type] = (analytics.statistics.byType[p.type] || 0) + 1;
      analytics.statistics.byStatus[p.status] = (analytics.statistics.byStatus[p.status] || 0) + 1;
      analytics.statistics.byLocation[p.location] = (analytics.statistics.byLocation[p.location] || 0) + 1;
    });

    var blob = new Blob([JSON.stringify(analytics, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'property-analytics-' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function handleCSVImport(e) {
    var file = e.target.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var csv = e.target.result;
        var lines = csv.split('\n');
        var headers = lines[0].split(',').map(function(h) { return h.trim(); });
        
        var importedCount = 0;
        
        for (var i = 1; i < lines.length; i++) {
          if (lines[i].trim() === '') continue;
          
          var values = parseCSVLine(lines[i]);
          if (values.length !== headers.length) continue;
          
          var property = {};
          headers.forEach(function(header, index) {
            var value = values[index];
            // Remove quotes if present
            if (typeof value === 'string' && value.startsWith('"') && value.endsWith('"')) {
              value = value.slice(1, -1);
            }
            
            // Convert numeric fields
            if (['Price', 'Bedrooms', 'Bathrooms', 'SquareMeters', 'ParkingSpaces'].includes(header)) {
              value = parseFloat(value) || 0;
            }
            
            // Parse arrays
            if (header === 'Features') {
              value = value ? value.split(',').map(function(f) { return f.trim(); }).filter(function(f) { return f; }) : [];
            } else if (header === 'Images') {
              value = value ? value.split('|').filter(function(img) { return img; }) : [];
            }
            
            property[header.toLowerCase()] = value;
          });
          
          // Generate ID if not present
          if (!property.id) {
            property.id = Date.now().toString() + i;
          }
          
          properties.push(property);
          importedCount++;
        }
        
        saveProperties();
        loadAdminProperties();
        alert('Successfully imported ' + importedCount + ' properties.');
        
      } catch (error) {
        alert('Error importing CSV file: ' + error.message);
        console.error('Import error:', error);
      }
    };
    
    reader.readAsText(file);
    e.target.value = '';
  }

  function parseCSVLine(line) {
    var result = [];
    var current = '';
    var inQuotes = false;
    
    for (var i = 0; i < line.length; i++) {
      var char = line[i];
      
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    
    result.push(current);
    return result;
  }

  // =================== Initialize Application ===================
  function initializeApp() {
    console.log('DOM fully loaded');
    init();
  }

  // Cross-browser DOM ready detection
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }

  // Make functions globally available
  window.editProperty = editProperty;
  window.deleteProperty = deleteProperty;
  window.duplicateProperty = duplicateProperty;

</script>

</body>
</html>
